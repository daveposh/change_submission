<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Request Form</title>
    
    <!-- FDK -->
    <script src="https://static.freshdev.io/fdk/2.0/assets/fresh_client.js"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="dist/app.css">
    <link rel="stylesheet" href="dist/lexical-editor.css">
    
    <!-- Application Scripts -->
    <script src="dist/app.bundle.js" defer></script>
    <script src="dist/lexical-editor.bundle.js" defer></script>
  </head>

  <body>
    <!-- Initialization Overlay -->
    <div id="initialization-overlay" class="initialization-overlay">
      <div class="initialization-content">
        <div class="initialization-spinner"></div>
        <div class="initialization-title">Initializing Change Request App</div>
        <div class="initialization-message" id="initialization-message">Setting up application...</div>
        <div class="initialization-progress">
          <div class="initialization-progress-bar" id="initialization-progress-bar"></div>
        </div>
      </div>
    </div>

    <div class="fw-widget-wrapper container-fluid py-4 app-initializing" id="app-content">
      <!-- Main Application Header -->
      <div class="app-header mb-4">
        <div class="d-flex align-items-center justify-content-center">
          <div class="app-icon me-3">
            <img src="styles/images/icon.svg" alt="CXI Change Request" class="app-icon-svg" width="48" height="48">
          </div>
          <h1 class="app-title mb-0">
            <span class="cxi-text">CXI</span>
            <span class="title-text">Change Request</span>
          </h1>
        </div>
      </div>

      <!-- Theme Selector and Help -->
      <div class="theme-selector-container mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="help-icon-container">
            <button type="button" class="btn btn-outline-primary btn-sm" id="start-guided-tour" title="Start Guided Tour">
              <i class="fas fa-question-circle me-1"></i>Help
            </button>
          </div>
          <div class="d-flex align-items-center">
            <label for="theme-selector" class="form-label me-2 mb-0">
              <i class="fas fa-palette me-1"></i>Theme:
            </label>
            <select id="theme-selector" class="form-select form-select-sm" style="width: auto;">
              <option value="light">Light Mode</option>
              <option value="dark">Dark Mode</option>
              <option value="auto">Auto (System)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="tabs-wrapper card">
        <ul class="nav nav-tabs" id="change-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#change-details" type="button" role="tab" aria-controls="change-details" aria-selected="true">Change Details</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="asset-association-tab" data-bs-toggle="tab" data-bs-target="#asset-association" type="button" role="tab" aria-controls="asset-association" aria-selected="false">
              Asset Association
              <span class="badge bg-success" style="display: none;">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="impacted-services-tab" data-bs-toggle="tab" data-bs-target="#impacted-services" type="button" role="tab" aria-controls="impacted-services" aria-selected="false">
              Impacted Services
              <span class="badge bg-info" style="display: none;">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="risk-tab" data-bs-toggle="tab" data-bs-target="#risk-assessment" type="button" role="tab" aria-controls="risk-assessment" aria-selected="false">Risk Assessment</button>
          </li>
        </ul>

        <div class="tab-content p-4" id="changeTabContent">
          <!-- Change Details Tab -->
          <div class="tab-pane fade show active" id="change-details" role="tabpanel" aria-labelledby="details-tab">
            <h3 class="mb-4">Change Details</h3>
            <div class="row g-3">
              <div class="col-12 form-group mb-3">
                <label for="change-title" class="form-label">Title of Change:</label>
                <input type="text" id="change-title" class="form-control" placeholder="Enter a descriptive title for this change request..." required>
                <div class="form-text">Provide a clear, concise title that describes what this change will accomplish.</div>
              </div>

              <div class="col-12 form-group mb-3">
                <label for="change-description" class="form-label">Description:</label>
                <div id="change-description" class="editor-container">
                  <div class="editor-toolbar">
                    <button data-action="bold" title="Bold"><i class="fas fa-bold"></i></button>
                    <button data-action="italic" title="Italic"><i class="fas fa-italic"></i></button>
                    <button data-action="underline" title="Underline"><i class="fas fa-underline"></i></button>
                    <button data-action="bullet-list" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                    <button data-action="numbered-list" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                    <button data-action="link" title="Insert Link"><i class="fas fa-link"></i></button>
                  </div>
                </div>
                <div class="form-text">Summarize what this change involves and what will be modified or implemented.</div>
              </div>

              <div class="col-md-6 form-group mb-3">
                <label for="requester" class="form-label">Requester:</label>
                <div class="search-input-container">
                  <input type="text" id="requester-search" class="form-control" placeholder="Search by name or email">
                  <div id="requester-results" class="search-results list-group"></div>
                </div>
                <div class="search-help-text small text-muted mt-1">
                  <i class="fas fa-bolt me-1 text-primary"></i>
                  <strong>Live Search:</strong> Start typing (3+ characters) for instant results, or press Enter for manual search.
                  <br>
                  <i class="fas fa-keyboard me-1 text-success"></i>
                  <strong>Keyboard Navigation:</strong> Use ↑↓ arrow keys to navigate, Enter to select, Escape to close.
                </div>
                <div id="selected-requester" class="selected-result mt-2 p-2 border rounded bg-light"></div>
              </div>

              <div class="col-md-6 form-group mb-3">
                <label for="agent" class="form-label">Agent (Technical SME):</label>
                <div class="search-input-container">
                  <input type="text" id="agent-search" class="form-control" placeholder="Search by name or email">
                  <div id="agent-results" class="search-results list-group"></div>
                </div>
                <div class="search-help-text small text-muted mt-1">
                  <i class="fas fa-bolt me-1 text-primary"></i>
                  <strong>Live Search:</strong> Start typing (3+ characters) for instant results, or press Enter for manual search.
                  <br>
                  <i class="fas fa-keyboard me-1 text-success"></i>
                  <strong>Keyboard Navigation:</strong> Use ↑↓ arrow keys to navigate, Enter to select, Escape to close.
                </div>
                <div id="selected-agent" class="selected-result mt-2 p-2 border rounded bg-light"></div>
              </div>

              <div class="col-md-6 form-group mb-3">
                <label for="change-type" class="form-label">Change Type:</label>
                <select id="change-type" class="form-select">
                  <option value="">Select Change Type</option>
                  <option value="normal">Normal Change</option>
                  <option value="emergency">Emergency Change</option>
                </select>
                <div id="change-type-tooltip" class="mt-2 p-2 border rounded bg-light change-type-info"></div>
              </div>

              <div class="col-md-6 form-group mb-3">
                <label class="form-label">Lead Time:</label>
                <div id="lead-time" class="lead-time-info p-2 border rounded bg-light">2 business days</div>
              </div>

              <div class="col-12 form-group mb-3">
                <label for="reason-for-change" class="form-label">Reason for Change:</label>
                <div id="reason-for-change" class="editor-container">
                  <div class="editor-toolbar">
                    <button data-action="bold" title="Bold"><i class="fas fa-bold"></i></button>
                    <button data-action="italic" title="Italic"><i class="fas fa-italic"></i></button>
                    <button data-action="underline" title="Underline"><i class="fas fa-underline"></i></button>
                    <button data-action="bullet-list" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                    <button data-action="numbered-list" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                    <button data-action="link" title="Insert Link"><i class="fas fa-link"></i></button>
                  </div>
                </div>
              </div>

              <div class="col-md-6 form-group mb-3">
                <label for="planned-start" class="form-label">Planned Start Date and Time:</label>
                <input type="datetime-local" id="planned-start" class="form-control">
              </div>

              <div class="col-md-6 form-group mb-3">
                <label for="planned-end" class="form-label">Planned End Date and Time:</label>
                <input type="datetime-local" id="planned-end" class="form-control">
              </div>

              <div class="col-12 form-group mb-3">
                <label for="implementation-plan" class="form-label">Implementation Plan:</label>
                <div id="implementation-plan" class="editor-container">
                  <div class="editor-toolbar">
                    <button data-action="bold" title="Bold"><i class="fas fa-bold"></i></button>
                    <button data-action="italic" title="Italic"><i class="fas fa-italic"></i></button>
                    <button data-action="underline" title="Underline"><i class="fas fa-underline"></i></button>
                    <button data-action="bullet-list" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                    <button data-action="numbered-list" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                    <button data-action="link" title="Insert Link"><i class="fas fa-link"></i></button>
                  </div>
                </div>
              </div>

              <div class="col-12 form-group mb-3">
                <label for="backout-plan" class="form-label">Backout (Recovery) Plan:</label>
                <div id="backout-plan" class="editor-container">
                  <div class="editor-toolbar">
                    <button data-action="bold" title="Bold"><i class="fas fa-bold"></i></button>
                    <button data-action="italic" title="Italic"><i class="fas fa-italic"></i></button>
                    <button data-action="underline" title="Underline"><i class="fas fa-underline"></i></button>
                    <button data-action="bullet-list" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                    <button data-action="numbered-list" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                    <button data-action="link" title="Insert Link"><i class="fas fa-link"></i></button>
                  </div>
                </div>
              </div>

              <div class="col-12 form-group mb-3">
                <label for="validation-plan" class="form-label">Validation Plan:</label>
                <div id="validation-plan" class="editor-container">
                  <div class="editor-toolbar">
                    <button data-action="bold" title="Bold"><i class="fas fa-bold"></i></button>
                    <button data-action="italic" title="Italic"><i class="fas fa-italic"></i></button>
                    <button data-action="underline" title="Underline"><i class="fas fa-underline"></i></button>
                    <button data-action="bullet-list" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                    <button data-action="numbered-list" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                    <button data-action="link" title="Insert Link"><i class="fas fa-link"></i></button>
                  </div>
                </div>
              </div>

              <div class="col-12 form-actions text-end">
                <button id="details-next" class="btn btn-primary" onclick="validateDetailsAndNext()">Next: Asset Association</button>
              </div>
            </div>
          </div>

          <!-- Asset Association Tab -->
          <div class="tab-pane fade" id="asset-association" role="tabpanel" aria-labelledby="asset-association-tab">
            <div class="asset-association-container">
              <h3 class="mb-4">Asset Association</h3>
              <p class="text-secondary mb-4">Associate assets that will be affected by this change request. You can search for assets by name and add them to your change.</p>

              <!-- Services Selection Section -->
              <div class="services-selection-section">
                <h5><i class="fas fa-cogs me-2"></i>Select Services</h5>
                <p class="text-muted small mb-3">Choose from available services that will be impacted by this change.</p>
                
                <!-- Services Filter and Search Controls -->
                <div class="services-controls mb-3">
                  <div class="row g-2">
                    <div class="col-md-4">
                      <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="services-search" class="form-control" placeholder="Quick search services...">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <select id="service-type-filter" class="form-select">
                        <option value="">All Service Types</option>
                        <option value="software">Software Services</option>
                        <option value="infrastructure">Infrastructure Services</option>
                        <option value="network">Network Services</option>
                        <option value="database">Database Services</option>
                        <option value="application">Application Services</option>
                        <option value="other">Other Services</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <div class="d-flex gap-2">
                        <button type="button" id="clear-services-filters-btn" class="btn btn-outline-secondary btn-sm">
                          <i class="fas fa-times me-1"></i>Clear Filters
                        </button>
                        <button type="button" id="refresh-services-btn" class="btn btn-outline-secondary btn-sm">
                          <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Services List with Enhanced Display -->
                <div class="services-list-container">
                  <div class="services-list-header">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span class="text-muted small">
                        <span id="services-shown-count">0</span> of <span id="services-total-count">0</span> services shown
                      </span>
                      <div class="services-list-actions">
                        <button type="button" id="unselect-all-services-btn" class="btn btn-outline-secondary btn-sm me-2">
                          <i class="fas fa-times-circle me-1"></i>Unselect All
                        </button>
                        <button type="button" id="add-selected-services-btn" class="btn btn-success btn-sm">
                          <i class="fas fa-plus me-1"></i>Add Selected
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Enhanced Services List -->
                  <div id="services-list" class="services-list">
                    <div class="services-loading">
                      <div class="d-flex align-items-center justify-content-center p-4">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        <span>Loading services...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Asset Search Section -->
              <div class="asset-search-section">
                <h5><i class="fas fa-search me-2"></i>Search All Assets</h5>
                <div class="asset-search-form">
                  <input type="text" id="asset-search-input" class="form-control" placeholder="Enter asset name to search all assets...">
                  <button type="button" id="asset-search-btn" class="btn btn-primary">
                    <i class="fas fa-search me-1"></i>Search
                  </button>
                </div>
                <div class="search-help-text">
                  <i class="fas fa-bolt me-1 text-primary"></i>
                  <strong>Live Search:</strong> Start typing (3+ characters) for instant results, or press Enter/click Search for manual search.
                </div>
                <div class="search-help-text mt-2">
                  <i class="fas fa-globe me-1 text-info"></i>
                  <strong>Note:</strong> This search covers all assets in the system.
                </div>

                <!-- Search Results -->
                <div id="asset-search-results" class="asset-search-results" style="display: none;"></div>
              </div>

              <!-- Selected Assets Section -->
              <div class="selected-assets-section">
                <div class="selected-assets-header">
                  <h5><i class="fas fa-link me-2"></i>Selected Assets</h5>
                  <div class="d-flex align-items-center gap-2">
                    <span class="asset-count-badge">
                      <span id="selected-assets-count">0</span> selected
                    </span>
                    <button type="button" id="clear-all-assets-btn" class="btn btn-sm btn-outline-danger clear-all-assets-btn">
                      <i class="fas fa-trash me-1"></i>Clear All
                    </button>
                  </div>
                </div>

                <!-- Selected Assets List -->
                <div id="selected-assets-list">
                  <div class="no-assets-message">
                    <i class="fas fa-info-circle text-muted"></i>
                    <span class="text-muted">No assets selected. Use the search above to find and add assets.</span>
                  </div>
                </div>
              </div>

              <!-- Navigation -->
              <div class="form-actions d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary" onclick="switchTab('change-details')">
                  <i class="fas fa-arrow-left me-1"></i>Back to Details
                </button>
                <button type="button" id="assets-next" class="btn btn-primary" onclick="validateAssetsAndNext()">
                  Next: Impacted Services<i class="fas fa-arrow-right ms-1"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Impacted Services Tab -->
          <div class="tab-pane fade" id="impacted-services" role="tabpanel" aria-labelledby="impacted-services-tab">
            <div class="impacted-services-container">
              <h3 class="mb-4">Impacted Services</h3>
              <p class="text-secondary mb-4">Analyze approvers and stakeholders from asset relationships.</p>

              <!-- Impacted Services Section -->
              <div class="impacted-services-section">
                <div class="impacted-services-header">
                  <h5><i class="fas fa-users me-2"></i>Impacted Services</h5>
                  <div class="d-flex align-items-center gap-2">
                    <span class="service-count-badge">
                      <span id="impacted-services-count">0</span> impacted services
                    </span>
                    <button type="button" id="analyze-services-btn" class="btn btn-sm btn-primary">
                      <i class="fas fa-search me-1"></i>Analyze Services
                    </button>
                  </div>
                </div>

                <!-- Analysis Status -->
                <div id="analysis-status" class="analysis-status" style="display: none;">
                  <div class="d-flex align-items-center p-3 bg-light rounded">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>Analyzing asset relationships and building impact assessment...</span>
                  </div>
                </div>

                <!-- Approvers Section -->
                <div class="approvers-section mt-4">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6><i class="fas fa-user-check me-2 text-success"></i>Direct Asset Approvers</h6>
                    <button type="button" class="btn btn-sm btn-outline-success" id="add-approver-btn">
                      <i class="fas fa-plus me-1"></i>Add Approver
                    </button>
                  </div>
                  <p class="small text-muted">Approvers derived from directly associated assets</p>
                  <div class="search-input-container mb-3" id="approver-search-container" style="display: none;">
                    <input type="text" id="approver-search" class="form-control" placeholder="Search by name or email">
                    <div id="approver-results" class="search-results list-group"></div>
                  </div>
                  <div id="approvers-list" class="users-list">
                    <div class="no-data-message">
                      <i class="fas fa-info-circle text-muted"></i>
                      <span class="text-muted">No approvers identified. Click "Analyze Services" to scan associated assets.</span>
                    </div>
                  </div>
                </div>

                <!-- Stakeholders Section -->
                <div class="stakeholders-section mt-4">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6><i class="fas fa-users me-2 text-primary"></i>Stakeholders from Related Assets</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="add-stakeholder-btn">
                      <i class="fas fa-plus me-1"></i>Add Stakeholder
                    </button>
                  </div>
                  <p class="small text-muted">Stakeholders from assets that have relationships with directly associated assets</p>
                  <div class="search-input-container mb-3" id="stakeholder-search-container" style="display: none;">
                    <input type="text" id="stakeholder-search" class="form-control" placeholder="Search by name or email">
                    <div id="stakeholder-results" class="search-results list-group"></div>
                  </div>
                  <div id="stakeholders-list" class="users-list">
                    <div class="no-data-message">
                      <i class="fas fa-info-circle text-muted"></i>
                      <span class="text-muted">No stakeholders identified. Click "Analyze Services" to scan related assets.</span>
                    </div>
                  </div>
                </div>

                <!-- Summary Section -->
                <div class="impact-summary mt-4" id="impact-summary" style="display: none;">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Impact Summary</h6>
                    </div>
                    <div class="card-body">
                      <div class="row">
                        <div class="col-md-6">
                          <div class="summary-item d-flex align-items-center">
                            <span class="summary-label">Direct Assets:</span>
                            <span class="summary-value me-2" id="direct-assets-count">0</span>
                            <button type="button" class="btn btn-link btn-sm p-0" 
                                    data-bs-toggle="popover" 
                                    data-bs-placement="top"
                                    data-bs-html="true"
                                    data-bs-content="<div>Assets selected in the <strong>Asset Association</strong> step that will be directly modified or impacted by this change.</div>"
                                    title="Direct Assets">
                              <i class="fas fa-info-circle text-info"></i>
                            </button>
                          </div>
                          <div class="summary-item d-flex align-items-center">
                            <span class="summary-label">Related Assets:</span>
                            <span class="summary-value me-2" id="related-assets-count">0</span>
                            <button type="button" class="btn btn-link btn-sm p-0" 
                                    data-bs-toggle="popover" 
                                    data-bs-placement="top"
                                    data-bs-html="true"
                                    data-bs-content="<div>Additional assets discovered through relationship analysis that may be indirectly affected by changes to the direct assets.</div>"
                                    title="Related Assets">
                              <i class="fas fa-info-circle text-info"></i>
                            </button>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="summary-item d-flex align-items-center">
                            <span class="summary-label">Total Approvers:</span>
                            <span class="summary-value me-2" id="total-approvers-count">0</span>
                            <button type="button" class="btn btn-link btn-sm p-0" 
                                    data-bs-toggle="popover" 
                                    data-bs-placement="top"
                                    data-bs-html="true"
                                    data-bs-content="<div>Technical owners and managers who must review and approve this change before implementation. These individuals have management responsibility for the affected assets.</div>"
                                    title="Technical Approvers">
                              <i class="fas fa-info-circle text-info"></i>
                            </button>
                          </div>
                          <div class="summary-item d-flex align-items-center">
                            <span class="summary-label">Total Stakeholders:</span>
                            <span class="summary-value me-2" id="total-stakeholders-count">0</span>
                            <button type="button" class="btn btn-link btn-sm p-0" 
                                    data-bs-toggle="popover" 
                                    data-bs-placement="top"
                                    data-bs-html="true"
                                    data-bs-content="<div>Users and team members who will be notified about this change for awareness. They don't need to approve but should be informed of potential impacts to their work.</div>"
                                    title="Stakeholders">
                              <i class="fas fa-info-circle text-info"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Navigation -->
              <div class="form-actions d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary" onclick="switchTab('asset-association')">
                  <i class="fas fa-arrow-left me-1"></i>Back to Assets
                </button>
                <button type="button" id="services-next" class="btn btn-primary" onclick="validateServicesAndNext()">
                  Next: Risk Assessment<i class="fas fa-arrow-right ms-1"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Risk Assessment Tab -->
          <div class="tab-pane fade" id="risk-assessment" role="tabpanel" aria-labelledby="risk-tab">
            <h3 class="mb-4">Risk Assessment</h3>
            <p class="text-secondary">Please answer all questions to determine the risk level of this change.</p>

            <div class="risk-question card mb-4 p-3">
              <label class="fw-bold mb-2">What is the potential business impact if the change fails?</label>
              <div class="risk-options">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="business-impact" id="impact-1" value="1">
                  <label class="form-check-label" for="impact-1">
                    Low - Limited impact on business operations
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="business-impact" id="impact-2" value="2">
                  <label class="form-check-label" for="impact-2">
                    Medium - Noticeable impact on some business operations
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="business-impact" id="impact-3" value="3">
                  <label class="form-check-label" for="impact-3">
                    High - Significant impact on business operations
                  </label>
                </div>
              </div>
            </div>

            <div class="risk-question card mb-4 p-3">
              <label class="fw-bold mb-2">How many users will be affected by this change?</label>
              <div class="risk-options">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="affected-users" id="users-1" value="1">
                  <label class="form-check-label" for="users-1">
                    Few (<50 users)
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="affected-users" id="users-2" value="2">
                  <label class="form-check-label" for="users-2">
                    Some (50-200 users)
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="affected-users" id="users-3" value="3">
                  <label class="form-check-label" for="users-3">
                    Many (>200 users)
                  </label>
                </div>
              </div>
            </div>

            <div class="risk-question card mb-4 p-3">
              <label class="fw-bold mb-2">How complex is this change?</label>
              <div class="risk-options">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="complexity" id="complexity-1" value="1">
                  <label class="form-check-label" for="complexity-1">
                    Simple - Routine change with established procedures
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="complexity" id="complexity-2" value="2">
                  <label class="form-check-label" for="complexity-2">
                    Moderate - Some complexity but well understood
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="complexity" id="complexity-3" value="3">
                  <label class="form-check-label" for="complexity-3">
                    Complex - Multiple systems or uncommon procedures
                  </label>
                </div>
              </div>
            </div>

            <div class="risk-question card mb-4 p-3">
              <label class="fw-bold mb-2">What level of testing has been performed?</label>
              <div class="risk-options">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="testing" id="testing-1" value="1">
                  <label class="form-check-label" for="testing-1">
                    Comprehensive - Thoroughly tested in multiple environments
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="testing" id="testing-2" value="2">
                  <label class="form-check-label" for="testing-2">
                    Adequate - Primary functions tested in test environment
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="testing" id="testing-3" value="3">
                  <label class="form-check-label" for="testing-3">
                    Limited - Minimal testing or testing not possible
                  </label>
                </div>
              </div>
            </div>

            <div class="risk-question card mb-4 p-3">
              <label class="fw-bold mb-2">Is there a rollback plan available?</label>
              <div class="risk-options">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="rollback" id="rollback-1" value="1">
                  <label class="form-check-label" for="rollback-1">
                    Yes - Detailed rollback plan with proven procedures
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="rollback" id="rollback-2" value="2">
                  <label class="form-check-label" for="rollback-2">
                    Partial - Basic rollback steps identified
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="rollback" id="rollback-3" value="3">
                  <label class="form-check-label" for="rollback-3">
                    No - No rollback possible or very difficult
                  </label>
                </div>
              </div>
            </div>

            <div id="risk-result" class="risk-result card bg-light p-4 mb-4 hidden">
              <h4 class="mb-3">Risk Assessment Result</h4>
              <div class="risk-score mb-2">
                <span class="fw-bold">Risk Score: </span>
                <span id="risk-score-value"></span>
              </div>
              <div class="risk-level mb-2">
                <span class="fw-bold">Risk Level: </span>
                <span id="risk-level-value" class="badge"></span>
              </div>
              <div class="risk-explanation mt-3" id="risk-explanation"></div>
            </div>

            <div class="form-actions d-flex justify-content-between">
              <button type="button" class="btn btn-outline-secondary" onclick="switchTab('impacted-services')">
                <i class="fas fa-arrow-left me-1"></i>Back to Impacted Services
              </button>
              <div>
                <button id="calculate-risk" class="btn btn-secondary me-2" onclick="calculateRisk()">Calculate Risk</button>
                <button id="submit-change-btn" class="btn btn-primary" onclick="validateRiskAndNext()">Submit Change Request</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Submission Progress Modal -->
      <div class="modal fade" id="submission-progress-modal" tabindex="-1" aria-labelledby="submissionProgressLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="submissionProgressLabel">
                <i class="fas fa-cogs me-2"></i>
                Submitting Change Request
              </h5>
            </div>
            <div class="modal-body">
              <div class="submission-progress-container">
                <!-- Overall Progress -->
                <div class="mb-4">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Overall Progress</h6>
                    <span id="overall-progress-percent" class="badge bg-primary">0%</span>
                  </div>
                  <div class="progress mb-2" style="height: 10px;">
                    <div id="overall-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  <div id="overall-status" class="text-muted small">Initializing submission...</div>
                </div>

                <!-- Detailed Steps -->
                <div class="submission-steps">
                  <div class="step-item" id="step-validation">
                    <div class="d-flex align-items-center">
                      <div class="step-icon me-3">
                        <i class="fas fa-circle-notch fa-spin text-primary" style="display: none;"></i>
                        <i class="fas fa-circle text-muted"></i>
                        <i class="fas fa-check-circle text-success" style="display: none;"></i>
                        <i class="fas fa-exclamation-circle text-danger" style="display: none;"></i>
                      </div>
                      <div class="step-content flex-grow-1">
                        <div class="step-title fw-bold">Validating Request Data</div>
                        <div class="step-description text-muted small">Checking all required fields and data integrity</div>
                      </div>
                    </div>
                  </div>

                  <div class="step-item" id="step-risk-assessment">
                    <div class="d-flex align-items-center">
                      <div class="step-icon me-3">
                        <i class="fas fa-circle-notch fa-spin text-primary" style="display: none;"></i>
                        <i class="fas fa-circle text-muted"></i>
                        <i class="fas fa-check-circle text-success" style="display: none;"></i>
                        <i class="fas fa-exclamation-circle text-danger" style="display: none;"></i>
                      </div>
                      <div class="step-content flex-grow-1">
                        <div class="step-title fw-bold">Processing Risk Assessment</div>
                        <div class="step-description text-muted small">Calculating risk scores and determining approval workflow</div>
                      </div>
                    </div>
                  </div>

                  <div class="step-item" id="step-creating-change">
                    <div class="d-flex align-items-center">
                      <div class="step-icon me-3">
                        <i class="fas fa-circle-notch fa-spin text-primary" style="display: none;"></i>
                        <i class="fas fa-circle text-muted"></i>
                        <i class="fas fa-check-circle text-success" style="display: none;"></i>
                        <i class="fas fa-exclamation-circle text-danger" style="display: none;"></i>
                      </div>
                      <div class="step-content flex-grow-1">
                        <div class="step-title fw-bold">Creating Change Request</div>
                        <div class="step-description text-muted small">Submitting change request to Freshservice</div>
                      </div>
                    </div>
                  </div>

                  <div class="step-item" id="step-associating-assets">
                    <div class="d-flex align-items-center">
                      <div class="step-icon me-3">
                        <i class="fas fa-circle-notch fa-spin text-primary" style="display: none;"></i>
                        <i class="fas fa-circle text-muted"></i>
                        <i class="fas fa-check-circle text-success" style="display: none;"></i>
                        <i class="fas fa-exclamation-circle text-danger" style="display: none;"></i>
                      </div>
                      <div class="step-content flex-grow-1">
                        <div class="step-title fw-bold">Associating Assets</div>
                        <div class="step-description text-muted small">Linking selected assets to the change request</div>
                      </div>
                    </div>
                  </div>

                  <div class="step-item" id="step-creating-tasks">
                    <div class="d-flex align-items-center">
                      <div class="step-icon me-3">
                        <i class="fas fa-circle-notch fa-spin text-primary" style="display: none;"></i>
                        <i class="fas fa-circle text-muted"></i>
                        <i class="fas fa-check-circle text-success" style="display: none;"></i>
                        <i class="fas fa-exclamation-circle text-danger" style="display: none;"></i>
                      </div>
                      <div class="step-content flex-grow-1">
                        <div class="step-title fw-bold">Creating Approval Tasks</div>
                        <div class="step-description text-muted small">Setting up peer review and approval workflow</div>
                      </div>
                    </div>
                  </div>

                  <div class="step-item" id="step-notifications">
                    <div class="d-flex align-items-center">
                      <div class="step-icon me-3">
                        <i class="fas fa-circle-notch fa-spin text-primary" style="display: none;"></i>
                        <i class="fas fa-circle text-muted"></i>
                        <i class="fas fa-check-circle text-success" style="display: none;"></i>
                        <i class="fas fa-exclamation-circle text-danger" style="display: none;"></i>
                      </div>
                      <div class="step-content flex-grow-1">
                        <div class="step-title fw-bold">Sending Notifications</div>
                        <div class="step-description text-muted small">Notifying stakeholders and approvers</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Error Details (hidden by default) -->
                <div id="submission-error-details" class="alert alert-danger mt-4" style="display: none;">
                  <h6 class="alert-heading">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Submission Error
                  </h6>
                  <div id="error-message"></div>
                  <hr>
                  <p class="mb-0">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="window.ChangeSubmission.retrySubmission()">
                      <i class="fas fa-redo me-1"></i>Retry Submission
                    </button>
                  </p>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" id="cancel-submission" style="display: none;">
                <i class="fas fa-times me-2"></i>Cancel
              </button>
              <button type="button" class="btn btn-primary" id="close-progress" style="display: none;" data-bs-dismiss="modal">
                <i class="fas fa-check me-2"></i>Close
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Confirmation Modal -->
      <div class="modal fade" id="confirmation-modal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmModalLabel">
                <i class="fas fa-clipboard-check me-2 text-primary"></i>
                Review Change Request Submission
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="summary-content">
                <!-- Summary content will be dynamically populated -->
                <div class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading summary...</span>
                  </div>
                  <p class="mt-2 text-muted">Preparing submission summary...</p>
                </div>
              </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
              <button id="edit-request" type="button" class="btn btn-outline-secondary">
                <i class="fas fa-edit me-2"></i>Edit Request
              </button>
              <button id="confirm-submit" type="button" class="btn btn-primary btn-lg">
                <i class="fas fa-paper-plane me-2"></i>Confirm & Submit
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Success Modal -->
      <div class="modal fade" id="success-modal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h5 class="modal-title" id="successModalLabel">
                <i class="fas fa-check-circle me-2"></i>
                Change Request Submitted Successfully!
              </h5>
            </div>
            <div class="modal-body">
              <div id="success-content">
                <!-- Success content will be dynamically populated -->
              </div>
            </div>
            <div class="modal-footer d-flex justify-content-center gap-3">
              <a id="view-change-btn" href="#" target="_blank" class="btn btn-success">
                <i class="fas fa-external-link-alt me-2"></i>View Change in Freshservice
              </a>
              <button id="new-change-btn" type="button" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create Another Change
              </button>
              <button id="close-success-btn" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-2"></i>Close & View Details
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Submission Status -->
      <div id="submission-status" class="alert alert-info" style="display: none;">
        <div class="d-flex align-items-center">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
          <span>Submitting change request...</span>
        </div>
      </div>

      <!-- Submission Summary -->
      <div id="submission-summary"></div>
    </div>
  </body>
</html>
