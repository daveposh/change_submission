<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChangeSubmission Module Test</title>
</head>
<body>
    <h1>ChangeSubmission Module Test</h1>
    <div id="test-results"></div>
    
    <script>
        // Mock the client object for testing
        window.client = {
            request: {
                invokeTemplate: async (template, options) => {
                    console.log('Mock API call:', template, options);
                    return { response: JSON.stringify({ change: { id: 123, subject: 'Test Change' } }) };
                }
            },
            iparams: {
                get: async () => ({ freshservice_domain: 'test.freshservice.com' })
            }
        };
        
        // Mock other dependencies
        window.changeRequestData = {
            changeTitle: 'Test Change',
            reasonForChange: 'Test reason',
            implementationPlan: 'Test plan',
            backoutPlan: 'Test backout',
            validationPlan: 'Test validation',
            plannedStart: '2025-01-15T10:00',
            plannedEnd: '2025-01-15T12:00',
            changeType: 'normal',
            selectedRequester: { id: 1, name: 'Test Requester' },
            selectedAgent: { id: 2, name: 'Test Agent' },
            riskAssessment: { riskLevel: 'Medium', totalScore: 8 },
            selectedAssets: [{ id: 1, name: 'Test Asset', asset_tag: 'TAG001' }]
        };
        
        window.ImpactedServices = {
            getImpactedServicesData: () => ({
                directAssets: [],
                relatedAssets: [],
                approvers: [{ id: 3, name: 'Test Approver', email: 'approver@test.com', source: 'Test' }],
                stakeholders: [{ id: 4, name: 'Test Stakeholder', email: 'stakeholder@test.com', source: 'Test' }],
                analysisComplete: true
            })
        };
    </script>
    
    <!-- Load the ChangeSubmission module -->
    <script src="app/scripts/change-submission.js"></script>
    
    <script>
        // Test the module
        document.addEventListener('DOMContentLoaded', () => {
            const results = document.getElementById('test-results');
            
            function addResult(message, isSuccess = true) {
                const div = document.createElement('div');
                div.style.color = isSuccess ? 'green' : 'red';
                div.style.margin = '5px 0';
                div.textContent = message;
                results.appendChild(div);
            }
            
            // Test 1: Check if module is loaded
            if (window.ChangeSubmission) {
                addResult('✅ ChangeSubmission module is loaded');
            } else {
                addResult('❌ ChangeSubmission module is NOT loaded', false);
                return;
            }
            
            // Test 2: Check if methods exist
            const requiredMethods = ['init', 'handleSubmission', 'validateSubmissionData', 'prepareChangeRequestData'];
            requiredMethods.forEach(method => {
                if (typeof window.ChangeSubmission[method] === 'function') {
                    addResult(`✅ Method ${method} exists`);
                } else {
                    addResult(`❌ Method ${method} is missing`, false);
                }
            });
            
            // Test 3: Test validation
            try {
                const validation = window.ChangeSubmission.validateSubmissionData();
                if (validation.isValid) {
                    addResult('✅ Validation passed');
                } else {
                    addResult(`⚠️ Validation failed: ${validation.message}`);
                }
            } catch (error) {
                addResult(`❌ Validation error: ${error.message}`, false);
            }
            
            // Test 4: Test data preparation
            try {
                window.ChangeSubmission.prepareChangeRequestData().then(data => {
                    if (data && data.subject) {
                        addResult('✅ Data preparation successful');
                    } else {
                        addResult('❌ Data preparation failed - no subject', false);
                    }
                }).catch(error => {
                    addResult(`❌ Data preparation error: ${error.message}`, false);
                });
            } catch (error) {
                addResult(`❌ Data preparation error: ${error.message}`, false);
            }
            
            addResult('🎉 Module test completed!');
        });
    </script>
</body>
</html> 